name: CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.DEPLOY_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      - name: Remote Deploy via SSH
        run: |
          echo "ðŸš€ Connecting and deploying remotely..."
          ssh root@213.239.193.208 <<'EOF'
            set -e

            echo "ðŸ”§ Sourcing NVM..."
            source ~/.nvm/nvm.sh || echo "âš ï¸ Failed to source NVM"

            echo "ðŸ“‚ Changing to project directory..."
            cd /var/www/html/ergodocs/tools || { echo "âŒ Failed to cd to project dir"; exit 1; }

            echo "ðŸ”„ Pulling latest changes from Git..."
            git pull || { echo "âŒ Git pull failed"; exit 1; }

            echo "ðŸ§¹ Cleaning old MkDocs site..."
            rm -rf site || echo "âš ï¸ Failed to remove site dir"

            echo "ðŸ— Building MkDocs site..."
            mkdocs build || { echo "âŒ MkDocs build failed"; exit 1; }

          EOF

      - name: Verify Remote Site Files
        run: |
          echo "ðŸ” Checking recently updated files..."
          ssh root@213.239.193.208 'find /var/www/html/ergodocs/site -type f -printf "ðŸ•’ %TY-%Tm-%Td %TH:%TM:%TS %p\n" | sort -r | head -n 10'

      - name: Check Web Server Served Files
        run: |
          echo "ðŸ” Verifying web server output..."
          curl -s -I https://docs.ergoplatform.com/ | grep "Last-Modified" || echo "âŒ Web server is serving outdated content or request failed!"
