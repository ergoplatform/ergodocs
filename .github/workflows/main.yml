name: CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.DEPLOY_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      - name: Remote Deploy via SSH
        run: |
          echo "ğŸš€ Connecting and scanning remote server..."
          ssh root@213.239.193.208 <<'EOF'
            set -e

            echo "ğŸ” Searching for nvm.sh..."
            find / -type f -name "nvm.sh" 2>/dev/null | tee /tmp/found_nvm.txt
            if [ -s /tmp/found_nvm.txt ]; then
              echo "âœ… Found nvm.sh:"
              cat /tmp/found_nvm.txt
            else
              echo "âŒ nvm.sh not found"
            fi

            echo "ğŸ” Searching for 'ergodocs' directory..."
            find / -type d -name "*ergodocs*" 2>/dev/null | tee /tmp/found_dirs.txt
            if [ -s /tmp/found_dirs.txt ]; then
              echo "âœ… Found ergodocs directories:"
              cat /tmp/found_dirs.txt
            else
              echo "âŒ ergodocs directory not found"
            fi
          EOF


      - name: Verify Remote Site Files
        run: |
          echo "ğŸ” Checking recently updated files..."
          ssh root@213.239.193.208 'find /var/www/html/ergodocs/site -type f -printf "ğŸ•’ %TY-%Tm-%Td %TH:%TM:%TS %p\n" | sort -r | head -n 10'

      - name: Check Web Server Served Files
        run: |
          echo "ğŸ” Verifying web server output..."
          curl -s -I https://docs.ergoplatform.com/ | grep "Last-Modified" || echo "âŒ Web server is serving outdated content or request failed!"
