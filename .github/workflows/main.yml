name: CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.DEPLOY_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      - name: Remote Deploy via SSH
        run: |
          echo "üöÄ Deploying to remote server..."
          ssh root@213.239.193.208 "export GITHUB_SHA=$GITHUB_SHA; bash -s" <<'EOF'
            set -eo pipefail

            echo "üìÇ Changing to project directory..."
            cd /var/www/ergodocs || { echo "‚ùå Failed to cd to project dir"; exit 1; }

            echo "üîÑ Resetting repository to expected commit..."
            git fetch origin main || { echo "‚ùå Git fetch failed"; exit 1; }
            git reset --hard "${GITHUB_SHA}" || { echo "‚ùå Git reset failed"; exit 1; }
            git clean -fd

            echo "üß∞ Ensuring python3-venv is available..."
            apt-get update -y && apt-get install -y python3-venv

            echo "üêç Setting up virtual environment..."
            python3 -m venv .venv
            source .venv/bin/activate

            echo "üì¶ Installing dependencies..."
            pip install --upgrade pip
            pip install -r requirements.txt || { echo "‚ùå Pip install failed"; exit 1; }

            echo "üßπ Cleaning old MkDocs site..."
            rm -rf site || echo "‚ö†Ô∏è Failed to remove site dir"

            echo "üèó Building MkDocs site..."
            mkdocs build || { echo "‚ùå MkDocs build failed"; exit 1; }

            echo "ü™™ Writing deploy metadata..."
            echo "${GITHUB_SHA}" > site/deploy-sha.txt
            date -u +"%Y-%m-%dT%H:%M:%SZ" > site/deploy-timestamp.txt
          EOF

      - name: Verify Remote Site Files
        run: |
          echo "üîç Checking recently updated files..."
          ssh root@213.239.193.208 'find /var/www/ergodocs/site -type f -printf "üïí %TY-%Tm-%Td %TH:%TM:%TS %p\n" | sort -r | head -n 10'

      - name: Check Web Server Served Files
        run: |
          echo "üîç Verifying web server output..."
          DEPLOYED_SHA=$(curl -fsS https://docs.ergoplatform.com/deploy-sha.txt || true)
          if [ -z "$DEPLOYED_SHA" ]; then
            echo "‚ùå Unable to read deployed SHA from web server"
            exit 1
          fi
          echo "üåê Remote site reports commit: $DEPLOYED_SHA"
          if [ "$DEPLOYED_SHA" != "$GITHUB_SHA" ]; then
            echo "‚ùå Remote site commit does not match expected $GITHUB_SHA"
            exit 1
          fi
          echo "‚úÖ Remote site matches expected commit"
